{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Permeability 3D Tool</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1400px;
      margin: 20px auto;
    }

    input[type="text"], input[type="number"] {
      padding: 5px;
    }
    input[type="text"] {
      width: 360px;
    }
    button {
      padding: 6px 12px;
    }

    .layout {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      align-items: flex-start;
    }

    .left-panel { flex: 2; }

    .right-panel {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto auto;
      gap: 16px;
      margin-top: 20px;
      align-items: start;
    }

    .box {
      border: 1px solid #ccc;
      background: #fafafa;
      padding: 10px 14px;
    }

    .box h3 { margin: 0 0 8px 0; }

    .error {
      color: red;
      margin-top: 8px;
    }

    /* ✅ 인쇄 시 숨김 */
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>

<body>
  <h1>Korea University GIT-PAMPA Permeability Prediction Tool</h1>

  <!-- ✅ 그래프 생성 폼 (PDF에는 숨김) -->
  {% if not is_pdf %}
  <form method="post" class="no-print">
    {% csrf_token %}
    <label>SMILES:</label>
    <input type="text" name="smiles" value="{{ smiles_value }}">

    <span style="margin-left:20px;">고정 변수:</span>
    <label style="margin-left:8px;">
      <input type="radio" name="fixed_var" value="dmso"
             {% if fixed_var == "dmso" %}checked{% endif %}> DMSO
    </label>
    <label style="margin-left:8px;">
      <input type="radio" name="fixed_var" value="lec"
             {% if fixed_var == "lec" %}checked{% endif %}> Lecithin
    </label>
    <label style="margin-left:8px;">
      <input type="radio" name="fixed_var" value="ph"
             {% if fixed_var == "ph" %}checked{% endif %}> pH
    </label>

    <button type="submit" name="create_graph" style="margin-left:12px;">그래프 생성</button>
  </form>
  {% endif %}

  {% if error %}
  <div class="error">{{ error }}</div>
  {% endif %}

  <div class="layout">
    <!-- 왼쪽: 그래프 -->
    <div class="left-panel">
      {% if not is_pdf %}
        {% if plot_html %}
          {{ plot_html|safe }}
        {% endif %}
      {% else %}
        <div style="border:1px solid #ddd; background:#fff; padding:12px; font-size:0.95em; color:#555;">
          PDF에는 3D 그래프가 정적 이미지로 포함됩니다. (웹에서는 인터랙티브 그래프 표시)
        </div>
      {% endif %}
    </div>

    <!-- 오른쪽: 박스 -->
    <div class="right-panel">

      <!-- (1) 모델 성능 -->
      <div class="box" style="grid-column: 1; grid-row: 1;">
        <h3>모델 성능</h3>
        {% if model_meta.r2 %}
          <p>R²: {{ model_meta.r2|floatformat:4 }}</p>
          <p>RMSE: {{ model_meta.rmse|floatformat:4 }}</p>
          <p>MAE: {{ model_meta.mae|floatformat:4 }}</p>
          <p>MAPE: {{ model_meta.mape|floatformat:4 }}%</p>
        {% else %}
          <p>모델 성능 정보를 불러오지 못했습니다.</p>
        {% endif %}
      </div>

      <!-- (2) RDKit -->
      <div class="box" style="grid-column: 2; grid-row: 1 / span 3;">
        <h3>RDKit 분자 특성</h3>
        {% if rdkit_desc %}
          <ul>
            <li>분자량 (MolWt): <b>{{ rdkit_desc.MolWt|floatformat:2 }}</b></li>
            <li>logP: <b>{{ rdkit_desc.LogP|floatformat:2 }}</b></li>
            <li>극성 표면적 (TPSA): <b>{{ rdkit_desc.TPSA|floatformat:2 }}</b> Å²</li>
            <li>H-bond Donors (HBD): <b>{{ rdkit_desc.HBD }}</b></li>
            <li>H-bond Acceptors (HBA): <b>{{ rdkit_desc.HBA }}</b></li>
            <li>회전 가능한 결합: <b>{{ rdkit_desc.RotatableBonds }}</b></li>
            <li>Ring 수 (RingCount): <b>{{ rdkit_desc.RingCount }}</b></li>
            <li>Heavy Atom 수: <b>{{ rdkit_desc.HeavyAtomCount }}</b></li>
          </ul>
        {% else %}
          <div style="font-size: 0.90em; color: #666;">
            그래프 생성 후 표시됩니다.
          </div>
        {% endif %}
      </div>

      <!-- (3) 변수 민감도 -->
      <div class="box" style="grid-column: 1; grid-row: 2;">
        <h3>변수 민감도 (Local Sensitivity)</h3>
        {% if sensitivity %}
          <p>각 변수 변화 시 ΔlogPe:</p>
          <ul>
            <li>Lec (+1): <b>{{ sensitivity.lec|floatformat:3 }}</b></li>
            <li>pH (+0.1): <b>{{ sensitivity.ph|floatformat:3 }}</b></li>
            <li>DMSO (+1): <b>{{ sensitivity.dmso|floatformat:3 }}</b></li>
          </ul>
        {% else %}
          <div style="font-size: 0.90em; color: #666;">
            그래프 생성 후 표시됩니다.
          </div>
        {% endif %}
      </div>

      <!-- (4) 단일 조건 예측 -->
      <div class="box" style="grid-column: 1; grid-row: 3;">
        <h3>단일 조건 예측</h3>

        <!-- ✅ 단일조건 폼은 PDF에서는 숨김 -->
        {% if not is_pdf %}
        <form method="post" class="no-print">
          {% csrf_token %}
          <input type="hidden" name="smiles_hidden" value="{{ smiles_value }}">
          <input type="hidden" name="fixed_var_hidden" value="{{ fixed_var }}">

          <p>
            Lecithin(%):
            <input type="number" name="lec_value" step="0.5"
                   value="{{ lec_value|floatformat:2 }}">
          </p>
          <p>
            pH:
            <input type="number" name="ph_value" step="0.1"
                   value="{{ ph_value|floatformat:2 }}">
          </p>
          <p>
            DMSO(%):
            <input type="number" name="dmso_value" step="0.5"
                   value="{{ dmso_value|floatformat:2 }}">
          </p>

          <button type="submit" name="single_predict">Confirm</button>
        </form>
        {% endif %}

        {% if single_pred %}
          <p style="margin-top:8px;">
            예측 logPe: <b>{{ single_pred|floatformat:3 }}</b>
          </p>
        {% endif %}

        <!-- ✅ 단일조건 결과가 있을 때만 PDF 버튼 표시 -->
        {% if single_pred and not is_pdf %}
          <form method="post" action="{% url 'permeability_pdf' %}" class="no-print" style="margin-top:10px;">
            {% csrf_token %}
            <input type="hidden" name="smiles" value="{{ smiles_value }}">
            <input type="hidden" name="fixed_var" value="{{ fixed_var }}">
            <input type="hidden" name="lec_value" value="{{ lec_value }}">
            <input type="hidden" name="ph_value" value="{{ ph_value }}">
            <input type="hidden" name="dmso_value" value="{{ dmso_value }}">
            <button type="submit">이 단일조건 결과를 PDF로 저장</button>
          </form>
          <div class="no-print" style="margin-top:6px; font-size:0.85em; color:#666;">
            ※ 단일 조건 예측을 Confirm 한 값 기준으로 PDF가 생성됩니다.
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</body>
</html>
